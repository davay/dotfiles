#!/bin/sh

# Because Git submodule commands cannot operate without a work tree, they must
# be run from within $HOME (assuming this is the root of your dotfiles)
cd $HOME

echo "Init submodules"
yadm submodule update --recursive --init

system_type=$(uname -s)

if [[ $system_type = "Darwin" ]]; then
	# Install packages
	brew install ansible
	ansible-galaxy install -r ~/.config/yadm/requirements.yml
	ansible-playbook -v ~/.config/yadm/mac-install.yml -i ~/.config/yadm/inventory

	# Misc
	yes | sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"

	# Disable sound effects on boot
        sudo nvram StartupMute=%01

	# Yabai
	sudo nvram boot-args=-arm64e_preview_abi
	brew services start yabai
	
        # Uncomment for Scripting addition, currently not supported for Apple Silicon
        # sudo sh -c "echo 'davay ALL = (root) NOPASSWD: /usr/local/bin/yabai --load-sa' >> /private/etc/sudoers.d/yabai"
	
	# Finishing touch
	gh auth login

elif [[ $system_type = "Linux" ]]; then # built for manjaro i3 minimal
	if [[ $(command -v pacman) ]]; then
		sudo pacman --noconfirm -S ansible
		ansible-galaxy collection install kewlfft.aur
		ansible-playbook -v ~/.config/yadm/linux-install.yml
		yes | sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
		sudo chsh -s /bin/zsh davay
		sudo chsh -s /bin/zsh
		sudo modprobe i2c-dev
		sudo modprobe i2c-piix4
		sudo udevadm control --reload-rules && sudo udevadm trigger
		sudo timedatectl set-ntp true
		sudo systemctl enable teamviewerd
		wpg-install.sh -g
		wpg -a ~/.config/yadm/background/*
		sudo chmod a+wr /opt/spotify
		sudo chmod a+wr /opt/spotify/Apps -R
		sudo updatedb
		sudo systemctl enable bluetooth.service
		betterdiscordctl install
	fi

fi
